{% extends "base.html" %}

{% block title %}ä¸Šä¼ æ–‡ä»¶ - E2EE æ–‡ä»¶ä¼ è¾“{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“¤ å®‰å…¨ä¸Šä¼ æ–‡ä»¶</h2>
    <p>ä½ æ­£åœ¨å‘æ¥æ”¶è€…å‘é€åŠ å¯†æ–‡ä»¶ã€‚æ–‡ä»¶å°†åœ¨æµè§ˆå™¨ç«¯åŠ å¯†åä¸Šä¼ ã€‚</p>

    <div class="info-box">
        <h3>ğŸ” åŠ å¯†æµç¨‹</h3>
        <ol>
            <li>ä½ é€‰æ‹©çš„æ–‡ä»¶å°†ä½¿ç”¨ <strong>AES-256-GCM</strong> åŠ å¯†</li>
            <li>AES å¯†é’¥ä½¿ç”¨æ¥æ”¶è€…çš„ <strong>RSA-4096 å…¬é’¥</strong>åŠ å¯†</li>
            <li>æœåŠ¡å™¨åªæ¥æ”¶å¯†æ–‡ï¼Œæ— æ³•æŸ¥çœ‹æ–‡ä»¶å†…å®¹</li>
            <li>åªæœ‰æ¥æ”¶è€…çš„ç§é’¥èƒ½è§£å¯†æ–‡ä»¶</li>
        </ol>
    </div>

    <div id="status-message"></div>

    <!-- æ­¥éª¤ 1: é€‰æ‹©æ–‡ä»¶ -->
    <div id="step-select">
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
            <div class="upload-icon">ğŸ“</div>
            <p><strong>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</strong> æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
            <p class="text-muted">æœ€å¤§æ”¯æŒ 500MB</p>
        </div>
        
        <div id="fileInfo" style="display: none;">
            <div class="file-preview">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-details">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
                <button class="btn-small btn-secondary" onclick="resetFileSelect()">âœ– é‡é€‰</button>
            </div>
            <button class="btn" id="uploadBtn" onclick="startUpload()">
                ğŸ”’ åŠ å¯†å¹¶ä¸Šä¼ 
            </button>
        </div>
    </div>

    <!-- æ­¥éª¤ 2: åŠ å¯†å’Œä¸Šä¼ ä¸­ -->
    <div id="step-uploading" style="display: none;">
        <div class="upload-status">
            <div class="status-icon">âš™ï¸</div>
            <h3 id="uploadStatusText">æ­£åœ¨åŠ å¯†æ–‡ä»¶...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
    </div>

    <!-- æ­¥éª¤ 3: ä¸Šä¼ æˆåŠŸ -->
    <div id="step-success" style="display: none;">
        <div class="message success">
            <h3>âœ… ä¸Šä¼ æˆåŠŸï¼</h3>
            <p>æ–‡ä»¶å·²å®‰å…¨åŠ å¯†å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p>
            <p>æ¥æ”¶è€…å¯ä»¥ä½¿ç”¨æ­¤é“¾æ¥ä¸‹è½½æ–‡ä»¶ï¼š</p>
            <div class="link-box">
                <input type="text" id="downloadLink" readonly value="{{ base_url }}/receive/{{ url_token }}">
                <button class="btn" onclick="copyDownloadLink()">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>

        <div class="message info">
            <strong>âš ï¸ æé†’æ¥æ”¶è€…ï¼š</strong>
            <ul>
                <li>éœ€è¦ä½¿ç”¨ä¹‹å‰ä¸‹è½½çš„ <code>private_key.pem</code> æ–‡ä»¶</li>
                <li>æ–‡ä»¶å°†åœ¨ <strong>24 å°æ—¶å</strong>æˆ–<strong>ä¸‹è½½å</strong>è‡ªåŠ¨åˆ é™¤</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ›¡ï¸ å®‰å…¨ä¿éšœ</h2>
    <div class="security-features">
        <div class="feature-item">
            <div class="feature-icon">ğŸ”</div>
            <h4>ç«¯åˆ°ç«¯åŠ å¯†</h4>
            <p>æ–‡ä»¶åœ¨ä½ çš„æµè§ˆå™¨ä¸­åŠ å¯†ï¼ŒæœåŠ¡å™¨æ— æ³•è§£å¯†</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">ğŸ”‘</div>
            <h4>éå¯¹ç§°åŠ å¯†</h4>
            <p>ä½¿ç”¨ RSA-4096 + AES-256 åŒé‡åŠ å¯†</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">â°</div>
            <h4>è‡ªåŠ¨é”€æ¯</h4>
            <p>24å°æ—¶åæˆ–ä¸‹è½½åç«‹å³åˆ é™¤</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crypto.js"></script>
<script>
const urlToken = "{{ url_token }}";
let selectedFile = null;
let publicKey = null;

// é¡µé¢åŠ è½½æ—¶è·å–å…¬é’¥
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`/api/get-public-key/${urlToken}`);
        if (!response.ok) {
            throw new Error('æ— æ³•è·å–å…¬é’¥');
        }
        const data = await response.json();
        publicKey = await importPublicKey(data.public_key);
        console.log('âœ… å…¬é’¥åŠ è½½æˆåŠŸ');
    } catch (error) {
        console.error('âŒ å…¬é’¥åŠ è½½å¤±è´¥:', error);
        showError('æ— æ³•åŠ è½½åŠ å¯†å¯†é’¥ï¼Œè¯·è”ç³»æ¥æ”¶è€…é‡æ–°ç”Ÿæˆé“¾æ¥');
    }
});

// æ‹–æ‹½ä¸Šä¼ 
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect({ target: { files } });
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // æ£€æŸ¥æ–‡ä»¶å¤§å° (500MB)
    const maxSize = 500 * 1024 * 1024;
    if (file.size > maxSize) {
        showError('æ–‡ä»¶å¤§å°è¶…è¿‡ 500MB é™åˆ¶');
        return;
    }

    selectedFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'block';
}

function resetFileSelect() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
}

async function startUpload() {
    if (!selectedFile || !publicKey) {
        showError('è¯·é€‰æ‹©æ–‡ä»¶æˆ–ç­‰å¾…å…¬é’¥åŠ è½½');
        return;
    }

    // åˆ‡æ¢åˆ°ä¸Šä¼ ç•Œé¢
    document.getElementById('step-select').style.display = 'none';
    document.getElementById('step-uploading').style.display = 'block';

    try {
        // 1. è¯»å–æ–‡ä»¶
        updateProgress(10, 'æ­£åœ¨è¯»å–æ–‡ä»¶...');
        const fileData = await readFileAsArrayBuffer(selectedFile);

        // 2. ç”Ÿæˆ AES å¯†é’¥
        updateProgress(20, 'æ­£åœ¨ç”ŸæˆåŠ å¯†å¯†é’¥...');
        const aesKey = await generateAESKey();

        // 3. ç”¨ AES åŠ å¯†æ–‡ä»¶
        updateProgress(40, 'æ­£åœ¨åŠ å¯†æ–‡ä»¶...');
        const { encrypted, iv } = await encryptFileWithAES(fileData, aesKey);

        // 4. ç”¨ RSA å…¬é’¥åŠ å¯† AES å¯†é’¥
        updateProgress(60, 'æ­£åœ¨åŠ å¯†ä¼ è¾“å¯†é’¥...');
        const encryptedAESKey = await encryptAESKeyWithRSA(aesKey, publicKey);

        // 5. å‡†å¤‡ä¸Šä¼ æ•°æ®
        updateProgress(70, 'æ­£åœ¨å‡†å¤‡ä¸Šä¼ ...');
        const formData = new FormData();
        
        // å°†åŠ å¯†çš„æ–‡ä»¶å’Œ IV åˆå¹¶
        const combinedData = new Uint8Array(iv.length + encrypted.byteLength);
        combinedData.set(iv, 0);
        combinedData.set(new Uint8Array(encrypted), iv.length);
        
        formData.append('file', new Blob([combinedData]), selectedFile.name);
        formData.append('encrypted_aes_key', arrayBufferToBase64(encryptedAESKey));
        formData.append('original_filename', selectedFile.name);

        // 6. ä¸Šä¼ åˆ°æœåŠ¡å™¨
        updateProgress(80, 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');
        const response = await fetch(`/api/upload/${urlToken}`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('ä¸Šä¼ å¤±è´¥');
        }

        updateProgress(100, 'ä¸Šä¼ å®Œæˆï¼');
        
        // æ˜¾ç¤ºæˆåŠŸç•Œé¢
        setTimeout(() => {
            document.getElementById('step-uploading').style.display = 'none';
            document.getElementById('step-success').style.display = 'block';
        }, 500);

    } catch (error) {
        console.error('âŒ ä¸Šä¼ å¤±è´¥:', error);
        showError('ä¸Šä¼ å¤±è´¥: ' + error.message);
        document.getElementById('step-uploading').style.display = 'none';
        document.getElementById('step-select').style.display = 'block';
    }
}

function updateProgress(percent, text) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';
    document.getElementById('uploadStatusText').textContent = text;
}

function copyDownloadLink() {
    const linkInput = document.getElementById('downloadLink');
    linkInput.select();
    document.execCommand('copy');
    alert('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
}

function showError(message) {
    document.getElementById('status-message').innerHTML = `
        <div class="message error">âŒ ${message}</div>
    `;
}
</script>

<style>
.upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9ff;
}

.upload-area:hover, .upload-area.drag-over {
    border-color: #764ba2;
    background: #f0f4ff;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.file-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
}

.file-icon {
    font-size: 3rem;
}

.file-details {
    flex: 1;
    text-align: left;
}

.file-name {
    font-weight: 600;
    margin-bottom: 5px;
    word-break: break-all;
}

.file-size {
    color: #666;
    font-size: 0.9rem;
}

.btn-small {
    padding: 8px 16px;
    font-size: 0.9rem;
}

.upload-status {
    text-align: center;
    padding: 40px 20px;
}

.status-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.upload-status h3 {
    color: #667eea;
    margin-bottom: 20px;
}

#progressText {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    color: #667eea;
}

.security-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.feature-item h4 {
    color: #667eea;
    margin-bottom: 10px;
}

.feature-item p {
    font-size: 0.9rem;
    color: #666;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}上传文件 - E2EE 文件传输{% endblock %}

{% block content %}
<!-- 状态时间线 -->
<div class="card status-timeline-card">
    <h3>📊 传输进度</h3>
    <div class="timeline-horizontal">
        <div class="timeline-step completed">
            <div class="step-marker">✓</div>
            <div class="step-label">链接已创建</div>
        </div>
        <div class="timeline-line completed"></div>

        <div class="timeline-step active">
            <div class="step-marker">
                <div class="pulse"></div>
            </div>
            <div class="step-label">等待上传</div>
        </div>
        <div class="timeline-line"></div>

        <div class="timeline-step">
            <div class="step-marker">○</div>
            <div class="step-label">等待下载</div>
        </div>
        <div class="timeline-line"></div>

        <div class="timeline-step">
            <div class="step-marker">○</div>
            <div class="step-label">传输完成</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>📤 安全上传文件</h2>
    <p>你正在向接收者发送加密文件。文件将在浏览器端加密后上传。</p>

    <div class="info-box">
        <h3>🔐 加密流程</h3>
        <ol>
            <li>你选择的文件将使用 <strong>AES-256-GCM</strong> 加密</li>
            <li>AES 密钥使用接收者的 <strong>RSA-4096 公钥</strong>加密</li>
            <li>服务器只接收密文，无法查看文件内容</li>
            <li>只有接收者的私钥能解密文件</li>
        </ol>
    </div>

    <div id="status-message"></div>

    <!-- 步骤 1: 选择文件 -->
    <div id="step-select">
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
            <div class="upload-icon">📁</div>
            <p><strong>点击选择文件</strong> 或拖拽到此处</p>
            <p class="text-muted">最大支持 5GB</p>
        </div>

        <div id="fileInfo" style="display: none;">
            <div class="file-preview">
                <div class="file-icon">📄</div>
                <div class="file-details">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
                <button class="btn-small btn-secondary" onclick="resetFileSelect()">✖ 重选</button>
            </div>
            <button class="btn" id="uploadBtn" onclick="startUpload()">
                🔒 加密并上传
            </button>
        </div>
    </div>

    <!-- 步骤 2: 加密和上传中 -->
    <div id="step-uploading" style="display: none;">
        <div class="upload-status">
            <div class="status-icon">⚙️</div>
            <h3 id="uploadStatusText">正在加密文件...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
    </div>

    <!-- 步骤 3: 上传成功 -->
    <div id="step-success" style="display: none;">
        <div class="message success">
            <h3>✅ 上传成功！</h3>
            <p>文件已安全加密并上传到服务器。</p>
            <p>接收者可以访问相同的链接下载文件。</p>
        </div>

        <div class="message info">
            <strong>⚠️ 提醒接收者：</strong>
            <ul>
                <li>需要使用之前下载的 <code>private_key.pem</code> 文件</li>
                <li>文件将在 <strong>24 小时后</strong>或<strong>下载后</strong>自动删除</li>
            </ul>
        </div>

        <div style="margin-top: 20px;">
            <a href="/" class="btn btn-secondary" style="display: inline-block;">🏠 返回首页</a>
        </div>
    </div>
</div>

<div class="card">
    <h2>🛡️ 安全保障</h2>
    <div class="security-features">
        <div class="feature-item">
            <div class="feature-icon">🔐</div>
            <h4>端到端加密</h4>
            <p>文件在你的浏览器中加密，服务器无法解密</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">🔑</div>
            <h4>非对称加密</h4>
            <p>使用 RSA-4096 + AES-256 双重加密</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">⏰</div>
            <h4>自动销毁</h4>
            <p>24小时后或下载后立即删除</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crypto.js"></script>
<script>
const urlToken = "{{ url_token }}";
let selectedFile = null;
let publicKey = null;

// 页面加载时获取公钥
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`/api/get-public-key/${urlToken}`);
        if (!response.ok) {
            throw new Error('无法获取公钥');
        }
        const data = await response.json();
        publicKey = await importPublicKey(data.public_key);
        console.log('✅ 公钥加载成功');
    } catch (error) {
        console.error('❌ 公钥加载失败:', error);
        showError('无法加载加密密钥，请联系接收者重新生成链接');
    }
});

// 拖拽上传
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect({ target: { files } });
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // 检查文件大小 (5GB)
    const maxSize = 5120 * 1024 * 1024;
    if (file.size > maxSize) {
        showError('文件大小超过 5GB 限制');
        return;
    }

    selectedFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'block';
}

function resetFileSelect() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
}

async function startUpload() {
    if (!selectedFile || !publicKey) {
        showError('请选择文件或等待公钥加载');
        return;
    }

    // 切换到上传界面
    document.getElementById('step-select').style.display = 'none';
    document.getElementById('step-uploading').style.display = 'block';

    try {
        const isLargeFile = selectedFile.size > 50 * 1024 * 1024; // 50MB 以上使用分块

        // 2. 生成 AES 密钥
        updateProgress(5, '正在生成加密密钥...');
        const aesKey = await generateAESKey();

        let combinedData;

        if (isLargeFile) {
            // 大文件：分块加密
            updateProgress(10, `正在加密文件（共 ${formatFileSize(selectedFile.size)}）...`);

            const { encryptedChunks, iv } = await encryptFileInChunks(
                selectedFile,
                aesKey,
                (percent) => {
                    updateProgress(10 + percent * 0.4, `正在加密文件... ${percent}%`);
                }
            );

            // 合并所有加密分块
            const totalLength = iv.length + encryptedChunks.reduce((sum, chunk) => sum + chunk.length, 0);
            combinedData = new Uint8Array(totalLength);
            combinedData.set(iv, 0);

            let offset = iv.length;
            for (const chunk of encryptedChunks) {
                combinedData.set(chunk, offset);
                offset += chunk.length;
            }

        } else {
            // 小文件：整体加密
            updateProgress(10, '正在读取文件...');
            const fileData = await readFileAsArrayBuffer(selectedFile);

            updateProgress(30, '正在加密文件...');
            const { encrypted, iv } = await encryptFileWithAES(fileData, aesKey);

            // 合并 IV 和密文
            combinedData = new Uint8Array(iv.length + encrypted.byteLength);
            combinedData.set(iv, 0);
            combinedData.set(new Uint8Array(encrypted), iv.length);
        }

        // 4. 用 RSA 公钥加密 AES 密钥
        updateProgress(55, '正在加密传输密钥...');
        const encryptedAESKey = await encryptAESKeyWithRSA(aesKey, publicKey);

        // 5. 分片上传到服务器（支持断点续传）
        updateProgress(60, '正在准备上传...');

        const UPLOAD_CHUNK_SIZE = 5 * 1024 * 1024; // 5MB per upload chunk
        const totalUploadChunks = Math.ceil(combinedData.length / UPLOAD_CHUNK_SIZE);

        const uploadId = Date.now().toString(); // 上传会话 ID

        for (let i = 0; i < totalUploadChunks; i++) {
            const start = i * UPLOAD_CHUNK_SIZE;
            const end = Math.min(start + UPLOAD_CHUNK_SIZE, combinedData.length);
            const chunk = combinedData.slice(start, end);

            const formData = new FormData();
            formData.append('chunk', new Blob([chunk]));
            formData.append('chunk_index', i);
            formData.append('total_chunks', totalUploadChunks);
            formData.append('upload_id', uploadId);
            formData.append('encrypted_aes_key', arrayBufferToBase64(encryptedAESKey));
            formData.append('original_filename', selectedFile.name);

            // 上传分片（支持重试）
            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch(`/api/upload-chunk/${urlToken}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`上传分片失败: ${response.status}`);
                    }

                    break; // 成功，跳出重试循环
                } catch (error) {
                    retries--;
                    if (retries === 0) throw error;
                    console.warn(`分片 ${i} 上传失败，重试中... (剩余 ${retries} 次)`);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒后重试
                }
            }

            // 更新上传进度
            const uploadPercent = Math.round((i + 1) / totalUploadChunks * 100);
            updateProgress(60 + uploadPercent * 0.35, `正在上传文件... ${uploadPercent}%`);
        }

        // 6. 完成上传
        updateProgress(95, '正在完成上传...');
        const finalResponse = await fetch(`/api/finalize-upload/${urlToken}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                upload_id: uploadId,
                file_size: selectedFile.size
            })
        });

        if (!finalResponse.ok) {
            throw new Error('完成上传失败');
        }

        updateProgress(100, '上传完成！');

        // 显示成功界面
        setTimeout(() => {
            document.getElementById('step-uploading').style.display = 'none';
            document.getElementById('step-success').style.display = 'block';
        }, 500);

    } catch (error) {
        console.error('❌ 上传失败:', error);
        showError('上传失败: ' + error.message);
        document.getElementById('step-uploading').style.display = 'none';
        document.getElementById('step-select').style.display = 'block';
    }
}

function updateProgress(percent, text) {
    // 将传入的百分比数字格式化为最多两位小数的字符串
    const formattedPercentString = percent.toFixed(2);

    // 使用 parseFloat 将其转回数字，这样可以去掉末尾多余的 .00 (例如 100.00 会变成 100)
    const formattedPercentNumber = parseFloat(formattedPercentString);

    document.getElementById('progressFill').style.width = formattedPercentNumber + '%';
    document.getElementById('progressText').textContent = formattedPercentNumber + '%';
    document.getElementById('uploadStatusText').textContent = text;
}

function copyDownloadLink() {
    const linkInput = document.getElementById('downloadLink');
    linkInput.select();
    document.execCommand('copy');
    alert('✅ 链接已复制到剪贴板！');
}

function showError(message) {
    document.getElementById('status-message').innerHTML = `
        <div class="message error">❌ ${message}</div>
    `;
}
</script>

<style>
.upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9ff;
}

.upload-area:hover, .upload-area.drag-over {
    border-color: #764ba2;
    background: #f0f4ff;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.file-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
}

.file-icon {
    font-size: 3rem;
}

.file-details {
    flex: 1;
    text-align: left;
}

.file-name {
    font-weight: 600;
    margin-bottom: 5px;
    word-break: break-all;
}

.file-size {
    color: #666;
    font-size: 0.9rem;
}

.btn-small {
    padding: 8px 16px;
    font-size: 0.9rem;
}

.upload-status {
    text-align: center;
    padding: 40px 20px;
}

.status-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.upload-status h3 {
    color: #667eea;
    margin-bottom: 20px;
}

#progressText {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    color: #667eea;
}

.security-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.feature-item h4 {
    color: #667eea;
    margin-bottom: 10px;
}

.feature-item p {
    font-size: 0.9rem;
    color: #666;
}

.button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 20px;
}

@media (max-width: 768px) {
    .button-group {
        grid-template-columns: 1fr;
    }
}

/* 状态时间线样式 */
.status-timeline-card {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
    border-left: 4px solid #667eea;
    margin-bottom: 20px;
}

.status-timeline-card h3 {
    color: #667eea;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

.timeline-horizontal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
}

.step-marker {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e0e0e0;
    color: #999;
    font-weight: bold;
    font-size: 1.2rem;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.timeline-step.completed .step-marker {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.timeline-step.active .step-marker {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    animation: markerPulse 2s ease-in-out infinite;
}

@keyframes markerPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
    50% { transform: scale(1.1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6); }
}

.pulse {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(0.8); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

.step-label {
    font-size: 0.85rem;
    color: #666;
    text-align: center;
    font-weight: 600;
    white-space: nowrap;
}

.timeline-step.completed .step-label {
    color: #28a745;
}

.timeline-step.active .step-label {
    color: #667eea;
}

.timeline-line {
    flex: 1;
    height: 3px;
    background: #e0e0e0;
    margin: 0 10px;
    position: relative;
    top: -20px;
}

.timeline-line.completed {
    background: linear-gradient(90deg, #28a745, #20c997);
}

/* 响应式优化 */
@media (max-width: 768px) {
    .timeline-horizontal {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
    }

    .timeline-step {
        flex: 0 0 80px;
    }

    .step-marker {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .step-label {
        font-size: 0.75rem;
    }

    .timeline-line {
        min-width: 30px;
        top: -15px;
    }
}
</style>
{% endblock %}
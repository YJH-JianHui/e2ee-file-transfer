{% extends "base.html" %}

{% block title %}ä¸Šä¼ æ–‡ä»¶ - E2EE æ–‡ä»¶ä¼ è¾“{% endblock %}

{% block content %}
<!-- çŠ¶æ€æ—¶é—´çº¿ -->
<div class="card status-timeline-card">
    <h3>ğŸ“Š ä¼ è¾“è¿›åº¦</h3>
    <div class="timeline-horizontal">
        <div class="timeline-step completed">
            <div class="step-marker">âœ“</div>
            <div class="step-label">é“¾æ¥å·²åˆ›å»º</div>
        </div>
        <div class="timeline-line completed"></div>

        <div class="timeline-step active">
            <div class="step-marker">
                <div class="pulse"></div>
            </div>
            <div class="step-label">ç­‰å¾…ä¸Šä¼ </div>
        </div>
        <div class="timeline-line"></div>

        <div class="timeline-step">
            <div class="step-marker">â—‹</div>
            <div class="step-label">ç­‰å¾…ä¸‹è½½</div>
        </div>
        <div class="timeline-line"></div>

        <div class="timeline-step">
            <div class="step-marker">â—‹</div>
            <div class="step-label">ä¼ è¾“å®Œæˆ</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ“¤ å®‰å…¨ä¸Šä¼ æ–‡ä»¶</h2>
    <p>ä½ æ­£åœ¨å‘æ¥æ”¶è€…å‘é€åŠ å¯†æ–‡ä»¶ï¼Œæ–‡ä»¶å°†åœ¨æµè§ˆå™¨ç«¯åŠ å¯†åä¸Šä¼ ã€‚</p>

    <div class="info-box">
        <h3>ğŸ” åŠ å¯†æµç¨‹</h3>
        <ol>
            <li>ä½ é€‰æ‹©çš„æ–‡ä»¶å°†ä½¿ç”¨ <strong>AES</strong> åŠ å¯†</li>
            <li>AES å¯†é’¥ä½¿ç”¨æ¥æ”¶è€…çš„ <strong>RSA å…¬é’¥</strong>åŠ å¯†</li>
            <li>æœåŠ¡å™¨åªæ¥æ”¶<strong>å¯†æ–‡</strong>å’Œ<strong>åŠ å¯†çš„ASEå¯†é’¥</strong>ï¼Œæ— æ³•æŸ¥çœ‹æ–‡ä»¶å†…å®¹</li>
            <li>åªæœ‰<strong>æ¥æ”¶è€…çš„ç§é’¥</strong>èƒ½è§£å¯†æ–‡ä»¶</li>
        </ol>
    </div>

    <div id="status-message"></div>

    <!-- æ­¥éª¤ 1: é€‰æ‹©æ–‡ä»¶ -->
    <div id="step-select">
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
            <div class="upload-icon">ğŸ“</div>
            <p><strong>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</strong> æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
            <p class="text-muted">æœ€å¤§æ”¯æŒ 5GB</p>
        </div>

        <div id="fileInfo" style="display: none;">
            <div class="file-preview">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-details">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
                <button class="btn-small btn-secondary" onclick="resetFileSelect()">âœ– é‡é€‰</button>
            </div>
            <button class="btn" id="uploadBtn" onclick="startUpload()">
                ğŸ”’ åŠ å¯†å¹¶ä¸Šä¼ 
            </button>
        </div>
    </div>

    <!-- æ­¥éª¤ 2: åŠ å¯†å’Œä¸Šä¼ ä¸­ -->
    <div id="step-uploading" style="display: none;">
        <div class="upload-status">
            <div class="status-icon">âš™ï¸</div>
            <h3 id="uploadStatusText">æ­£åœ¨åŠ å¯†æ–‡ä»¶...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
    </div>
</div>

<!-- ä¸Šä¼ æˆåŠŸæ¨¡æ€å¯¹è¯æ¡† -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âœ… ä¸Šä¼ æˆåŠŸï¼</h2>
        </div>

        <div class="modal-body">
            <div class="success-box">
                <div class="success-icon-large">ğŸ‰</div>
                <h3>æ–‡ä»¶å·²å®‰å…¨åŠ å¯†å¹¶ä¸Šä¼ </h3>
                <p class="success-message">æ–‡ä»¶å·²æˆåŠŸåŠ å¯†å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæ¥æ”¶è€…å¯ä»¥ä½¿ç”¨ç›¸åŒçš„é“¾æ¥ä¸‹è½½æ–‡ä»¶ã€‚</p>
            </div>

            <div class="file-info-modal">
                <div class="info-row">
                    <span class="label">ğŸ“„ æ–‡ä»¶åï¼š</span>
                    <span class="value" id="successFilename">-</span>
                </div>
                <div class="info-row">
                    <span class="label">ğŸ’¾ å¤§å°ï¼š</span>
                    <span class="value" id="successFileSize">-</span>
                </div>
                <div class="info-row">
                    <span class="label">ğŸ” åŠ å¯†æ–¹å¼ï¼š</span>
                    <span class="value">AES + RSA</span>
                </div>
            </div>

            <div class="warning-notice">
                <div class="notice-icon">âš ï¸</div>
                <div class="notice-content">
                    <strong>æé†’æ¥æ”¶è€…</strong>
                    <ul>
                        <li>ä½¿ç”¨ä¹‹å‰ä¸‹è½½çš„ <code>private_key_xxxx.pem</code> æ–‡ä»¶è§£å¯†</li>
                        <li>æ–‡ä»¶å°†åœ¨ 24 å°æ—¶åæˆ–ä¸‹è½½åè‡ªåŠ¨åˆ é™¤</li>
                        <li>æ–‡ä»¶ä»…æ”¯æŒä¸€æ¬¡ä¸‹è½½ï¼Œè¯·å¦¥å–„ä¿å­˜è§£å¯†æ–‡ä»¶</li>
                    </ul>
                </div>
            </div>

            <div class="button-group-modal">
                <button class="btn btn-success btn-large" onclick="location.reload()">
                    ğŸ“¥ æŸ¥çœ‹ä¸‹è½½é¡µé¢
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ›¡ï¸ å®‰å…¨ä¿éšœ</h2>
    <div class="security-features">
        <div class="feature-item">
            <div class="feature-icon">ğŸ”</div>
            <h4>ç«¯åˆ°ç«¯åŠ å¯†</h4>
            <p>æ–‡ä»¶åœ¨ä½ çš„æµè§ˆå™¨ä¸­åŠ å¯†ï¼ŒæœåŠ¡å™¨æ— æ³•è§£å¯†</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">ğŸ”‘</div>
            <h4>éå¯¹ç§°åŠ å¯†</h4>
            <p>ä½¿ç”¨ RSA-4096 + AES åŒé‡åŠ å¯†</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">â°</div>
            <h4>è‡ªåŠ¨é”€æ¯</h4>
            <p>24å°æ—¶åæˆ–ä¸‹è½½åç«‹å³åˆ é™¤</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crypto.js"></script>
<script>
const urlToken = "{{ url_token }}";
let selectedFile = null;
let publicKey = null;

// é¡µé¢åŠ è½½æ—¶è·å–å…¬é’¥
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`/api/get-public-key/${urlToken}`);
        if (!response.ok) {
            throw new Error('æ— æ³•è·å–å…¬é’¥');
        }
        const data = await response.json();
        publicKey = await importPublicKey(data.public_key);
        console.log('âœ… å…¬é’¥åŠ è½½æˆåŠŸ');
    } catch (error) {
        console.error('âŒ å…¬é’¥åŠ è½½å¤±è´¥:', error);
        showError('æ— æ³•åŠ è½½åŠ å¯†å¯†é’¥ï¼Œè¯·è”ç³»æ¥æ”¶è€…é‡æ–°ç”Ÿæˆé“¾æ¥');
    }
});

// æ‹–æ‹½ä¸Šä¼ 
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect({ target: { files } });
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // æ£€æŸ¥æ–‡ä»¶å¤§å° (5GB)
    const maxSize = 5120 * 1024 * 1024;
    if (file.size > maxSize) {
        showError('æ–‡ä»¶å¤§å°è¶…è¿‡ 5GB é™åˆ¶');
        return;
    }

    selectedFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'block';
}

function resetFileSelect() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
}

async function startUpload() {
    if (!selectedFile || !publicKey) {
        showError('è¯·é€‰æ‹©æ–‡ä»¶æˆ–ç­‰å¾…å…¬é’¥åŠ è½½');
        return;
    }

    // åˆ‡æ¢åˆ°ä¸Šä¼ ç•Œé¢
    document.getElementById('step-select').style.display = 'none';
    document.getElementById('step-uploading').style.display = 'block';

    try {
        const isLargeFile = selectedFile.size > 50 * 1024 * 1024;

        // 2. ç”Ÿæˆ AES å¯†é’¥
        updateProgress(5, 'æ­£åœ¨ç”ŸæˆåŠ å¯†å¯†é’¥...');
        const aesKey = await generateAESKey();

        let combinedData;

        if (isLargeFile) {
            // å¤§æ–‡ä»¶ï¼šåˆ†å—åŠ å¯†
            updateProgress(10, `æ­£åœ¨åŠ å¯†æ–‡ä»¶ï¼ˆå…± ${formatFileSize(selectedFile.size)}ï¼‰...`);

            const { encryptedChunks, iv } = await encryptFileInChunks(
                selectedFile,
                aesKey,
                (percent) => {
                    updateProgress(10 + percent * 0.4, `æ­£åœ¨åŠ å¯†æ–‡ä»¶... ${percent}%`);
                }
            );

            const totalLength = iv.length + encryptedChunks.reduce((sum, chunk) => sum + chunk.length, 0);
            combinedData = new Uint8Array(totalLength);
            combinedData.set(iv, 0);

            let offset = iv.length;
            for (const chunk of encryptedChunks) {
                combinedData.set(chunk, offset);
                offset += chunk.length;
            }

        } else {
            // å°æ–‡ä»¶ï¼šæ•´ä½“åŠ å¯†
            updateProgress(10, 'æ­£åœ¨è¯»å–æ–‡ä»¶...');
            const fileData = await readFileAsArrayBuffer(selectedFile);

            updateProgress(30, 'æ­£åœ¨åŠ å¯†æ–‡ä»¶...');
            const { encrypted, iv } = await encryptFileWithAES(fileData, aesKey);

            combinedData = new Uint8Array(iv.length + encrypted.byteLength);
            combinedData.set(iv, 0);
            combinedData.set(new Uint8Array(encrypted), iv.length);
        }

        // 4. ç”¨ RSA å…¬é’¥åŠ å¯† AES å¯†é’¥
        updateProgress(55, 'æ­£åœ¨åŠ å¯†ä¼ è¾“å¯†é’¥...');
        const encryptedAESKey = await encryptAESKeyWithRSA(aesKey, publicKey);

        // 5. åˆ†ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨
        updateProgress(60, 'æ­£åœ¨å‡†å¤‡ä¸Šä¼ ...');

        const UPLOAD_CHUNK_SIZE = 5 * 1024 * 1024;
        const totalUploadChunks = Math.ceil(combinedData.length / UPLOAD_CHUNK_SIZE);
        const uploadId = Date.now().toString();

        for (let i = 0; i < totalUploadChunks; i++) {
            const start = i * UPLOAD_CHUNK_SIZE;
            const end = Math.min(start + UPLOAD_CHUNK_SIZE, combinedData.length);
            const chunk = combinedData.slice(start, end);

            const formData = new FormData();
            formData.append('chunk', new Blob([chunk]));
            formData.append('chunk_index', i);
            formData.append('total_chunks', totalUploadChunks);
            formData.append('upload_id', uploadId);
            formData.append('encrypted_aes_key', arrayBufferToBase64(encryptedAESKey));
            formData.append('original_filename', selectedFile.name);

            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch(`/api/upload-chunk/${urlToken}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`ä¸Šä¼ åˆ†ç‰‡å¤±è´¥: ${response.status}`);
                    }

                    break;
                } catch (error) {
                    retries--;
                    if (retries === 0) throw error;
                    console.warn(`åˆ†ç‰‡ ${i} ä¸Šä¼ å¤±è´¥ï¼Œé‡è¯•ä¸­... (å‰©ä½™ ${retries} æ¬¡)`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            const uploadPercent = Math.round((i + 1) / totalUploadChunks * 100);
            updateProgress(60 + uploadPercent * 0.35, `æ­£åœ¨ä¸Šä¼ æ–‡ä»¶... ${uploadPercent}%`);
        }

        // 6. å®Œæˆä¸Šä¼ 
        updateProgress(95, 'æ­£åœ¨å®Œæˆä¸Šä¼ ...');
        const finalResponse = await fetch(`/api/finalize-upload/${urlToken}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                upload_id: uploadId,
                file_size: selectedFile.size
            })
        });

        if (!finalResponse.ok) {
            throw new Error('å®Œæˆä¸Šä¼ å¤±è´¥');
        }

        updateProgress(100, 'ä¸Šä¼ å®Œæˆï¼');

        // æ›´æ–°æ—¶é—´çº¿çŠ¶æ€
        updateTimelineToUploaded();

        // æ˜¾ç¤ºæˆåŠŸæ¨¡æ€å¯¹è¯æ¡†
        setTimeout(() => {
            document.getElementById('step-uploading').style.display = 'none';
            openSuccessModal();
        }, 500);

    } catch (error) {
        console.error('âŒ ä¸Šä¼ å¤±è´¥:', error);
        showError('ä¸Šä¼ å¤±è´¥: ' + error.message);
        document.getElementById('step-uploading').style.display = 'none';
        document.getElementById('step-select').style.display = 'block';
    }
}

// æ‰“å¼€æˆåŠŸæ¨¡æ€å¯¹è¯æ¡†
function openSuccessModal() {
    const modal = document.getElementById('successModal');

    // è®¾ç½®æ–‡ä»¶ä¿¡æ¯
    document.getElementById('successFilename').textContent = selectedFile.name;
    document.getElementById('successFileSize').textContent = formatFileSize(selectedFile.size);

    // æ˜¾ç¤ºå¯¹è¯æ¡†
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

// æ›´æ–°æ—¶é—´çº¿åˆ°"å·²ä¸Šä¼ "çŠ¶æ€
function updateTimelineToUploaded() {
    const steps = document.querySelectorAll('.timeline-step');
    const lines = document.querySelectorAll('.timeline-line');

    // ç¬¬ä¸€æ­¥ï¼šé“¾æ¥å·²åˆ›å»ºï¼ˆå·²å®Œæˆï¼‰
    steps[0].classList.add('completed');
    steps[0].classList.remove('active');

    // ç¬¬äºŒæ­¥ï¼šæ–‡ä»¶å·²ä¸Šä¼ ï¼ˆå®Œæˆï¼‰
    steps[1].classList.add('completed');
    steps[1].classList.remove('active');
    steps[1].querySelector('.step-marker').innerHTML = 'âœ“';

    // ç¬¬äºŒæ¡çº¿ï¼šå®Œæˆ
    if (lines[1]) {
        lines[1].classList.add('completed');
    }

    // ç¬¬ä¸‰æ­¥ï¼šç­‰å¾…ä¸‹è½½ï¼ˆæ¿€æ´»ï¼‰
    steps[2].classList.add('active');
    steps[2].classList.remove('completed');
}

function updateProgress(percent, text) {
    // å°†ä¼ å…¥çš„ç™¾åˆ†æ¯”æ•°å­—æ ¼å¼åŒ–ä¸ºæœ€å¤šä¸¤ä½å°æ•°çš„å­—ç¬¦ä¸²
    const formattedPercentString = percent.toFixed(2);

    // ä½¿ç”¨ parseFloat å°†å…¶è½¬å›æ•°å­—ï¼Œè¿™æ ·å¯ä»¥å»æ‰æœ«å°¾å¤šä½™çš„ .00 (ä¾‹å¦‚ 100.00 ä¼šå˜æˆ 100)
    const formattedPercentNumber = parseFloat(formattedPercentString);

    document.getElementById('progressFill').style.width = formattedPercentNumber + '%';
    document.getElementById('progressText').textContent = formattedPercentNumber + '%';
    document.getElementById('uploadStatusText').textContent = text;
}

function copyDownloadLink() {
    const linkInput = document.getElementById('downloadLink');
    linkInput.select();
    document.execCommand('copy');
    alert('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
}

function showError(message) {
    document.getElementById('status-message').innerHTML = `
        <div class="message error">âŒ ${message}</div>
    `;
}
</script>

<style>
.upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9ff;
}

.upload-area:hover, .upload-area.drag-over {
    border-color: #764ba2;
    background: #f0f4ff;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.file-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
}

.file-icon {
    font-size: 3rem;
}

.file-details {
    flex: 1;
    text-align: left;
}

.file-name {
    font-weight: 600;
    margin-bottom: 5px;
    word-break: break-all;
}

.file-size {
    color: #666;
    font-size: 0.9rem;
}

.btn-small {
    padding: 8px 16px;
    font-size: 0.9rem;
}

.upload-status {
    text-align: center;
    padding: 40px 20px;
}

.status-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.upload-status h3 {
    color: #667eea;
    margin-bottom: 20px;
}

#progressText {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    color: #667eea;
}

.security-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.feature-item h4 {
    color: #667eea;
    margin-bottom: 10px;
}

.feature-item p {
    font-size: 0.9rem;
    color: #666;
}

.button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 20px;
}

/* çŠ¶æ€æ—¶é—´çº¿æ ·å¼ */
.status-timeline-card {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
    border-left: 4px solid #667eea;
    margin-bottom: 20px;
}

.status-timeline-card h3 {
    color: #667eea;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

.timeline-horizontal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
}

.step-marker {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e0e0e0;
    color: #999;
    font-weight: bold;
    font-size: 1.2rem;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.timeline-step.completed .step-marker {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.timeline-step.active .step-marker {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    animation: markerPulse 2s ease-in-out infinite;
}

@keyframes markerPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
    50% { transform: scale(1.1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6); }
}

.pulse {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(0.8); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

.step-label {
    font-size: 0.85rem;
    color: #666;
    text-align: center;
    font-weight: 600;
    white-space: nowrap;
}

.timeline-step.completed .step-label {
    color: #28a745;
}

.timeline-step.active .step-label {
    color: #667eea;
}

.timeline-line {
    flex: 1;
    height: 3px;
    background: #e0e0e0;
    margin: 0 10px;
    position: relative;
    top: -20px;
}

.timeline-line.completed {
    background: linear-gradient(90deg, #28a745, #20c997);
}

/* æ¨¡æ€å¯¹è¯æ¡†åŸºç¡€æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
    animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideUp {
    from {
        transform: translateY(60px) scale(0.95);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.modal-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 30px;
    border-radius: 20px 20px 0 0;
    text-align: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.8rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.modal-body {
    padding: 35px;
}

/* æˆåŠŸæç¤ºæ¡† */
.success-box {
    text-align: center;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-radius: 16px;
    border-left: 5px solid #28a745;
}

.success-icon-large {
    font-size: 4rem;
    margin-bottom: 15px;
    animation: bounceIn 0.8s ease-out;
}

@keyframes bounceIn {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.success-box h3 {
    color: #155724;
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.success-message {
    color: #155724;
    font-size: 1.1rem;
    margin: 0;
    line-height: 1.6;
}

/* æ–‡ä»¶ä¿¡æ¯ */
.file-info-modal {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e0e0e0;
}

.info-row:last-child {
    border-bottom: none;
}

.info-row .label {
    font-weight: 600;
    color: #666;
    font-size: 1rem;
}

.info-row .value {
    color: #333;
    font-weight: 500;
    font-size: 1rem;
    word-break: break-all;
    text-align: right;
    max-width: 60%;
}

/* è­¦å‘Šæç¤º */
.warning-notice {
    display: flex;
    gap: 15px;
    background: linear-gradient(135deg, #fff3cd, #ffe9a6);
    border-left: 4px solid #ffc107;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.notice-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
}

.notice-content {
    flex: 1;
}

.notice-content strong {
    color: #856404;
    font-size: 1.1rem;
    display: block;
    margin-bottom: 10px;
}

.notice-content ul {
    margin: 0;
    padding-left: 20px;
    color: #856404;
    line-height: 1.8;
}

.notice-content li {
    margin-bottom: 5px;
}

.notice-content code {
    background: rgba(0, 0, 0, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

/* æŒ‰é’®ç»„ */
.button-group-modal {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.btn-large {
    padding: 16px 24px;
    font-size: 1.1rem;
    font-weight: 700;
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    position: relative;
    overflow: hidden;
}

.btn-success::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn-success:hover::before {
    width: 300px;
    height: 300px;
}

.btn-success:hover {
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
    transform: translateY(-2px);
}

.btn-success:active {
    transform: translateY(0);
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .timeline-horizontal {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
    }

    .timeline-step {
        flex: 0 0 80px;
    }

    .step-marker {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .step-label {
        font-size: 0.75rem;
    }

    .timeline-line {
        min-width: 30px;
        top: -15px;
    }

    .modal-content {
        width: 95%;
        max-height: 95vh;
    }

    .modal-body {
        padding: 25px;
    }

    .button-group-modal {
        grid-template-columns: 1fr;
    }

    .info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .info-row .value {
        text-align: left;
        max-width: 100%;
    }

    .warning-notice {
        flex-direction: column;
        text-align: center;
    }
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
.modal-content::-webkit-scrollbar {
    width: 8px;
}

.modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 0 20px 20px 0;
}

.modal-content::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}
</style>
{% endblock %}
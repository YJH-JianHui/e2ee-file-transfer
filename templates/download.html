{% extends "base.html" %}

{% block title %}ä¸‹è½½æ–‡ä»¶ - E2EE æ–‡ä»¶ä¼ è¾“{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“¥ æ¥æ”¶åŠ å¯†æ–‡ä»¶</h2>
    <p>æœ‰äººå‘ä½ å‘é€äº†åŠ å¯†æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ä½ çš„ç§é’¥è¿›è¡Œè§£å¯†ã€‚</p>

    <div class="info-box">
        <h3>ğŸ”“ è§£å¯†æµç¨‹</h3>
        <ol>
            <li>ä¸Šä¼ ä½ ä¹‹å‰ä¸‹è½½çš„ <strong>private_key.pem</strong> æ–‡ä»¶</li>
            <li>ç³»ç»Ÿå°†ä¸‹è½½åŠ å¯†æ–‡ä»¶å’ŒåŠ å¯†çš„å¯†é’¥</li>
            <li>æµè§ˆå™¨ä½¿ç”¨ç§é’¥è§£å¯† AES å¯†é’¥</li>
            <li>ä½¿ç”¨ AES å¯†é’¥è§£å¯†æ–‡ä»¶</li>
            <li>è‡ªåŠ¨ä¸‹è½½è§£å¯†åçš„åŸå§‹æ–‡ä»¶</li>
        </ol>
    </div>

    <div id="file-info" class="file-info-box">
        <h3>ğŸ“„ æ–‡ä»¶ä¿¡æ¯</h3>
        <div class="info-item">
            <span class="label">åŸå§‹æ–‡ä»¶åï¼š</span>
            <span id="originalFilename">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
            <span class="label">æ–‡ä»¶å¤§å°ï¼š</span>
            <span id="fileSize">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
            <span class="label">ä¸Šä¼ æ—¶é—´ï¼š</span>
            <span id="uploadTime">åŠ è½½ä¸­...</span>
        </div>
    </div>

    <div id="status-message"></div>

    <!-- æ­¥éª¤ 1: ä¸Šä¼ ç§é’¥ -->
    <div id="step-upload-key">
        <div class="key-upload-area">
            <input type="file" id="privateKeyInput" accept=".pem" style="display: none;" onchange="handlePrivateKeySelect(event)">
            <div class="upload-icon">ğŸ”‘</div>
            <p><strong>ç‚¹å‡»ä¸Šä¼ ç§é’¥æ–‡ä»¶</strong></p>
            <p class="text-muted">æ–‡ä»¶åé€šå¸¸ä¸º private_key_xxxxx.pem</p>
            <button class="btn" onclick="document.getElementById('privateKeyInput').click()">
                ğŸ“‚ é€‰æ‹©ç§é’¥æ–‡ä»¶
            </button>
        </div>

        <div class="message info">
            <strong>âš ï¸ å®‰å…¨æç¤ºï¼š</strong>
            <ul>
                <li>ç§é’¥æ–‡ä»¶<strong>ä¸ä¼šä¸Šä¼ </strong>åˆ°æœåŠ¡å™¨</li>
                <li>æ‰€æœ‰è§£å¯†æ“ä½œåœ¨<strong>ä½ çš„æµè§ˆå™¨</strong>ä¸­å®Œæˆ</li>
                <li>è§£å¯†åæœåŠ¡å™¨æ–‡ä»¶å°†<strong>ç«‹å³åˆ é™¤</strong></li>
            </ul>
        </div>
    </div>

    <!-- æ­¥éª¤ 2: è§£å¯†ä¸­ -->
    <div id="step-decrypting" style="display: none;">
        <div class="decrypt-status">
            <div class="status-icon">ğŸ”“</div>
            <h3 id="decryptStatusText">æ­£åœ¨ä¸‹è½½åŠ å¯†æ–‡ä»¶...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
    </div>

    <!-- æ­¥éª¤ 3: è§£å¯†æˆåŠŸ -->
    <div id="step-success" style="display: none;">
        <div class="message success">
            <h3>âœ… æ–‡ä»¶è§£å¯†æˆåŠŸï¼</h3>
            <p>æ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½åˆ°ä½ çš„è®¾å¤‡ã€‚</p>
            <p>æœåŠ¡å™¨ä¸Šçš„åŠ å¯†æ–‡ä»¶å·²è¢«åˆ é™¤ã€‚</p>
        </div>

        <div class="success-info">
            <div class="success-icon">ğŸ“„</div>
            <p><strong>æ–‡ä»¶åï¼š</strong><span id="successFilename"></span></p>
            <p><strong>å¤§å°ï¼š</strong><span id="successFileSize"></span></p>
        </div>

        <button class="btn" onclick="location.href='/'">
            ğŸ  è¿”å›é¦–é¡µ
        </button>
    </div>
</div>

<div class="card">
    <h2>ğŸ”’ éšç§ä¿æŠ¤</h2>
    <div class="security-features">
        <div class="feature-item">
            <div class="feature-icon">ğŸ–¥ï¸</div>
            <h4>æœ¬åœ°è§£å¯†</h4>
            <p>æ‰€æœ‰è§£å¯†åœ¨æµè§ˆå™¨å®Œæˆï¼Œç§é’¥ä¸ä¼šç¦»å¼€ä½ çš„è®¾å¤‡</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">ğŸ—‘ï¸</div>
            <h4>è‡ªåŠ¨é”€æ¯</h4>
            <p>è§£å¯†æˆåŠŸåï¼ŒæœåŠ¡å™¨æ–‡ä»¶ç«‹å³æ°¸ä¹…åˆ é™¤</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">ğŸš«</div>
            <h4>é›¶çŸ¥è¯†</h4>
            <p>æœåŠ¡å™¨ä»æœªæ¥è§¦è¿‡æ˜æ–‡æ•°æ®æˆ–ç§é’¥</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crypto.js"></script>
<script>
const urlToken = "{{ url_token }}";
let privateKey = null;
let fileInfo = null;

// é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶ä¿¡æ¯
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`/api/get-file-info/${urlToken}`);
        if (!response.ok) {
            throw new Error('æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯');
        }

        fileInfo = await response.json();

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        document.getElementById('originalFilename').textContent = fileInfo.original_filename;
        document.getElementById('fileSize').textContent = formatFileSize(fileInfo.file_size);
        document.getElementById('uploadTime').textContent = new Date(fileInfo.created_at).toLocaleString('zh-CN');

        console.log('âœ… æ–‡ä»¶ä¿¡æ¯åŠ è½½æˆåŠŸ');
    } catch (error) {
        console.error('âŒ æ–‡ä»¶ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
        showError('æ— æ³•åŠ è½½æ–‡ä»¶ä¿¡æ¯: ' + error.message);
    }
});

async function handlePrivateKeySelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        // è¯»å–ç§é’¥æ–‡ä»¶
        const privateKeyPem = await readFileAsText(file);

        // éªŒè¯ç§é’¥æ ¼å¼
        if (!privateKeyPem.includes('-----BEGIN PRIVATE KEY-----')) {
            throw new Error('æ— æ•ˆçš„ç§é’¥æ–‡ä»¶æ ¼å¼');
        }

        // å¯¼å…¥ç§é’¥
        privateKey = await importPrivateKey(privateKeyPem);
        console.log('âœ… ç§é’¥å¯¼å…¥æˆåŠŸ');

        // å¼€å§‹è§£å¯†æµç¨‹
        await startDecryption();

    } catch (error) {
        console.error('âŒ ç§é’¥å¤„ç†å¤±è´¥:', error);
        showError('ç§é’¥æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºæ­£ç¡®çš„ç§é’¥æ–‡ä»¶');
        document.getElementById('privateKeyInput').value = '';
    }
}

async function startDecryption() {
    if (!privateKey || !fileInfo) {
        showError('è¯·å…ˆä¸Šä¼ ç§é’¥å¹¶ç­‰å¾…æ–‡ä»¶ä¿¡æ¯åŠ è½½');
        return;
    }

    // åˆ‡æ¢åˆ°è§£å¯†ç•Œé¢
    document.getElementById('step-upload-key').style.display = 'none';
    document.getElementById('step-decrypting').style.display = 'block';

    try {
        // 1. ä¸‹è½½åŠ å¯†æ–‡ä»¶
        updateProgress(20, 'æ­£åœ¨ä¸‹è½½åŠ å¯†æ–‡ä»¶...');
        const fileResponse = await fetch(`/api/download/${urlToken}`);
        if (!fileResponse.ok) {
            throw new Error('ä¸‹è½½åŠ å¯†æ–‡ä»¶å¤±è´¥');
        }
        const encryptedData = await fileResponse.arrayBuffer();
        console.log('âœ… åŠ å¯†æ–‡ä»¶ä¸‹è½½å®Œæˆ');

        // 2. æå– IV å’Œå¯†æ–‡ (å‰12å­—èŠ‚æ˜¯IV)
        updateProgress(30, 'æ­£åœ¨æå–åŠ å¯†å‚æ•°...');
        const iv = new Uint8Array(encryptedData.slice(0, 12));
        const encryptedFile = encryptedData.slice(12);

        // 3. è·å–åŠ å¯†çš„ AES å¯†é’¥
        updateProgress(40, 'æ­£åœ¨è·å–åŠ å¯†å¯†é’¥...');
        const keyResponse = await fetch(`/api/get-encrypted-key/${urlToken}`);
        if (!keyResponse.ok) {
            throw new Error('è·å–åŠ å¯†å¯†é’¥å¤±è´¥');
        }
        const keyData = await keyResponse.json();
        const encryptedAESKey = base64ToArrayBuffer(keyData.encrypted_aes_key);

        // 4. ä½¿ç”¨ç§é’¥è§£å¯† AES å¯†é’¥
        updateProgress(60, 'æ­£åœ¨è§£å¯†ä¼ è¾“å¯†é’¥...');
        const aesKey = await decryptAESKeyWithRSA(encryptedAESKey, privateKey);
        console.log('âœ… AES å¯†é’¥è§£å¯†æˆåŠŸ');

        // 5. ä½¿ç”¨ AES å¯†é’¥è§£å¯†æ–‡ä»¶
        updateProgress(80, 'æ­£åœ¨è§£å¯†æ–‡ä»¶å†…å®¹...');
        const decryptedFile = await decryptFileWithAES(encryptedFile, aesKey, iv);
        console.log('âœ… æ–‡ä»¶è§£å¯†æˆåŠŸ');

        // 6. ä¸‹è½½è§£å¯†åçš„æ–‡ä»¶
        updateProgress(90, 'æ­£åœ¨å‡†å¤‡ä¸‹è½½...');
        const blob = new Blob([decryptedFile]);
        downloadFile(blob, fileInfo.original_filename);

        // 7. é€šçŸ¥æœåŠ¡å™¨åˆ é™¤æ–‡ä»¶
        updateProgress(100, 'æ­£åœ¨æ¸…ç†æœåŠ¡å™¨æ–‡ä»¶...');
        await fetch(`/api/confirm-download/${urlToken}`, { method: 'POST' });

        // æ˜¾ç¤ºæˆåŠŸç•Œé¢
        document.getElementById('successFilename').textContent = fileInfo.original_filename;
        document.getElementById('successFileSize').textContent = formatFileSize(fileInfo.file_size);

        setTimeout(() => {
            document.getElementById('step-decrypting').style.display = 'none';
            document.getElementById('step-success').style.display = 'block';
        }, 500);

    } catch (error) {
        console.error('âŒ è§£å¯†å¤±è´¥:', error);
        showError('è§£å¯†å¤±è´¥: ' + error.message + '<br>è¯·ç¡®è®¤ç§é’¥æ˜¯å¦æ­£ç¡®');
        document.getElementById('step-decrypting').style.display = 'none';
        document.getElementById('step-upload-key').style.display = 'block';
        document.getElementById('privateKeyInput').value = '';
    }
}

function updateProgress(percent, text) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';
    document.getElementById('decryptStatusText').textContent = text;
}

function showError(message) {
    document.getElementById('status-message').innerHTML = `
        <div class="message error">âŒ ${message}</div>
    `;
}
</script>

<style>
.file-info-box {
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.file-info-box h3 {
    color: #667eea;
    margin-bottom: 15px;
}

.info-item {
    display: flex;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
}

.info-item:last-child {
    border-bottom: none;
}

.info-item .label {
    font-weight: 600;
    color: #666;
    min-width: 120px;
}

.key-upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 50px 20px;
    text-align: center;
    background: #f8f9ff;
    margin: 20px 0;
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.decrypt-status {
    text-align: center;
    padding: 40px 20px;
}

.status-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.decrypt-status h3 {
    color: #667eea;
    margin-bottom: 20px;
}

#progressText {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    color: #667eea;
}

.success-info {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    margin: 20px 0;
}

.success-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.success-info p {
    margin: 10px 0;
    font-size: 1.1rem;
}

.success-info strong {
    color: #667eea;
}

.security-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.feature-item h4 {
    color: #667eea;
    margin-bottom: 10px;
}

.feature-item p {
    font-size: 0.9rem;
    color: #666;
}

.info-box {
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.info-box h3 {
    color: #667eea;
    margin-bottom: 15px;
}

.info-box ol {
    margin-left: 20px;
    line-height: 1.8;
}

.info-box strong {
    color: #764ba2;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}下载文件 - E2EE 文件传输{% endblock %}

{% block content %}
<!-- 状态时间线 -->
<div class="card status-timeline-card">
    <h3>📊 传输进度</h3>
    <div class="timeline-horizontal">
        <div class="timeline-step completed">
            <div class="step-marker">✓</div>
            <div class="step-label">链接已创建</div>
        </div>
        <div class="timeline-line completed"></div>

        <div class="timeline-step completed">
            <div class="step-marker">✓</div>
            <div class="step-label">文件已上传</div>
        </div>
        <div class="timeline-line completed"></div>

        <div class="timeline-step active">
            <div class="step-marker">
                <div class="pulse"></div>
            </div>
            <div class="step-label">等待下载</div>
        </div>
        <div class="timeline-line"></div>

        <div class="timeline-step">
            <div class="step-marker">○</div>
            <div class="step-label">传输完成</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>📥 接收加密文件</h2>
    <p>有人向你发送了加密文件，请上传你的私钥进行解密。</p>

    <div class="info-box">
        <h3>🔓 解密流程</h3>
        <ol>
            <li>上传你之前下载的 <strong>private_key_xxxx.pem</strong> 文件</li>
            <li>浏览器将下载加密文件和公钥加密的AES密钥</li>
            <li>浏览器使用私钥解密AES密钥</li>
            <li>浏览器使用AES密钥解密文件</li>
            <li>下载解密后的原始文件</li>
        </ol>
    </div>

    <div id="file-info" class="file-info-box">
        <h3>📄 文件信息</h3>
        <div class="info-item">
            <span class="label">原始文件名：</span>
            <span id="originalFilename">加载中...</span>
        </div>
        <div class="info-item">
            <span class="label">文件大小：</span>
            <span id="fileSize">加载中...</span>
        </div>
        <div class="info-item">
            <span class="label">上传时间：</span>
            <span id="uploadTime">加载中...</span>
        </div>
    </div>

    <div id="status-message"></div>

    <!-- 步骤 1: 上传私钥 -->
    <div id="step-upload-key">
        <div class="key-upload-area">
            <input type="file" id="privateKeyInput" accept=".pem" style="display: none;" onchange="handlePrivateKeySelect(event)">
            <div class="upload-icon">🔑</div>
            <p><strong>点击上传私钥文件</strong></p>
            <p class="text-muted">文件名通常为 private_key_xxxxx.pem</p>
            <button class="btn" onclick="document.getElementById('privateKeyInput').click()">
                📂 选择私钥文件
            </button>
        </div>

        <div class="message info">
            <strong>⚠️ 安全提示：</strong>
            <ul>
                <li>私钥文件<strong>不会上传</strong>到服务器</li>
                <li>所有解密操作在<strong>你的浏览器</strong>中完成</li>
                <li>解密后服务器文件将<strong>立即删除</strong></li>
            </ul>
        </div>
    </div>

    <!-- 步骤 2: 解密中 -->
    <div id="step-decrypting" style="display: none;">
        <div class="decrypt-status">
            <div class="status-icon">🔓</div>
            <h3 id="decryptStatusText">正在下载加密文件...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
    </div>

    <!-- 步骤 3: 解密成功 -->
    <div id="step-success" style="display: none;">
        <div class="message success">
            <h3>✅ 文件解密成功！</h3>
            <p>文件已下载解密完成，请保存到你的设备设备。</p>
            <p>服务器上的加密文件已被删除。</p>
        </div>

        <div class="success-info">
            <div class="success-icon">📄</div>
            <p><strong>文件名：</strong><span id="successFilename"></span></p>
            <p><strong>大小：</strong><span id="successFileSize"></span></p>
        </div>
    </div>
</div>

<div class="card">
    <h2>🔒 隐私保护</h2>
    <div class="security-features">
        <div class="feature-item">
            <div class="feature-icon">🖥️</div>
            <h4>本地解密</h4>
            <p>所有解密在浏览器完成，私钥不会离开你的设备</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">🗑️</div>
            <h4>自动销毁</h4>
            <p>解密成功后，服务器文件立即永久删除</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">🚫</div>
            <h4>零知识</h4>
            <p>服务器从未接触过明文数据或私钥</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crypto.js"></script>
<script>
const urlToken = "{{ url_token }}";
let privateKey = null;
let fileInfo = null;

// 页面加载时获取文件信息
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`/api/get-file-info/${urlToken}`);
        if (!response.ok) {
            throw new Error('无法获取文件信息');
        }

        fileInfo = await response.json();

        // 显示文件信息
        document.getElementById('originalFilename').textContent = fileInfo.original_filename;
        document.getElementById('fileSize').textContent = formatFileSize(fileInfo.file_size);
        document.getElementById('uploadTime').textContent = new Date(fileInfo.created_at).toLocaleString('zh-CN');

        console.log('✅ 文件信息加载成功');
    } catch (error) {
        console.error('❌ 文件信息加载失败:', error);
        showError('无法加载文件信息: ' + error.message);
    }
});

async function handlePrivateKeySelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        // 🔥 关键修复：清除之前的错误提示
        clearError();

        // 读取私钥文件
        const privateKeyPem = await readFileAsText(file);

        // 验证私钥格式
        if (!privateKeyPem.includes('-----BEGIN PRIVATE KEY-----')) {
            throw new Error('无效的私钥文件格式');
        }

        // 导入私钥
        privateKey = await importPrivateKey(privateKeyPem);
        console.log('✅ 私钥导入成功');

        // 开始解密流程
        await startDecryption();

    } catch (error) {
        console.error('❌ 私钥处理失败:', error);
        showError('私钥无效或格式错误，请确认是否为正确的私钥文件');
        document.getElementById('privateKeyInput').value = '';
    }
}

async function startDecryption() {
    if (!privateKey || !fileInfo) {
        showError('请先上传私钥并等待文件信息加载');
        return;
    }

    // 🔥 关键修复：切换界面时清除错误提示
    clearError();

    // 切换到解密界面
    document.getElementById('step-upload-key').style.display = 'none';
    document.getElementById('step-decrypting').style.display = 'block';

    try {
        const isLargeFile = fileInfo.file_size > 50 * 1024 * 1024;

        // 1. 下载加密文件
        updateProgress(10, '正在下载加密文件...');
        const fileResponse = await fetch(`/api/download/${urlToken}`);
        if (!fileResponse.ok) {
            throw new Error('下载加密文件失败');
        }

        const reader = fileResponse.body.getReader();
        const chunks = [];
        let receivedLength = 0;

        while(true) {
            const {done, value} = await reader.read();
            if (done) break;

            chunks.push(value);
            receivedLength += value.length;

            const downloadPercent = Math.round(receivedLength / fileInfo.file_size * 100);
            updateProgress(10 + downloadPercent * 0.2, `下载中... ${downloadPercent}%`);
        }

        const encryptedData = new Uint8Array(receivedLength);
        let position = 0;
        for(const chunk of chunks) {
            encryptedData.set(chunk, position);
            position += chunk.length;
        }

        // 2. 提取 IV 和密文
        updateProgress(35, '正在提取加密参数...');
        const iv = encryptedData.slice(0, 12);
        const encryptedFile = encryptedData.slice(12);

        // 3. 获取加密的 AES 密钥
        updateProgress(40, '正在获取加密密钥...');
        const keyResponse = await fetch(`/api/get-encrypted-key/${urlToken}`);
        if (!keyResponse.ok) {
            throw new Error('获取加密密钥失败');
        }
        const keyData = await keyResponse.json();
        const encryptedAESKey = base64ToArrayBuffer(keyData.encrypted_aes_key);

        // 4. 使用私钥解密 AES 密钥
        updateProgress(50, '正在解密传输密钥...');
        const aesKey = await decryptAESKeyWithRSA(encryptedAESKey, privateKey);
        console.log('✅ AES 密钥解密成功');

        // 5. 解密文件
        let decryptedFile;

        if (isLargeFile) {
            updateProgress(55, '正在解密大文件（分块处理）...');

            const CHUNK_SIZE = 5 * 1024 * 1024 + 16;
            const encryptedChunks = [];

            for (let i = 0; i < encryptedFile.length; i += CHUNK_SIZE) {
                encryptedChunks.push(encryptedFile.slice(i, Math.min(i + CHUNK_SIZE, encryptedFile.length)));
            }

            decryptedFile = await decryptFileInChunks(
                encryptedChunks,
                aesKey,
                iv,
                (percent) => {
                    updateProgress(55 + percent * 0.3, `解密中... ${percent}%`);
                }
            );
        } else {
            updateProgress(60, '正在解密文件内容...');
            decryptedFile = await decryptFileWithAES(encryptedFile.buffer, aesKey, iv);
        }

        console.log('✅ 文件解密成功');

        // 6. 下载解密后的文件
        updateProgress(90, '正在准备下载...');
        const blob = new Blob([decryptedFile]);
        downloadFile(blob, fileInfo.original_filename);

        // 7. 通知服务器删除文件
        updateProgress(95, '正在清理服务器文件...');
        await fetch(`/api/confirm-download/${urlToken}`, { method: 'POST' });

        updateProgress(100, '完成！');

        // 显示成功界面
        document.getElementById('successFilename').textContent = fileInfo.original_filename;
        document.getElementById('successFileSize').textContent = formatFileSize(fileInfo.file_size);

        // 更新时间线为全部完成
        updateTimelineCompleted();

        setTimeout(() => {
            document.getElementById('step-decrypting').style.display = 'none';
            document.getElementById('step-success').style.display = 'block';
        }, 500);

    } catch (error) {
        console.error('❌ 解密失败:', error);
        showError('解密失败: ' + error.message + '<br>请确认私钥是否正确');
        document.getElementById('step-decrypting').style.display = 'none';
        document.getElementById('step-upload-key').style.display = 'block';
        document.getElementById('privateKeyInput').value = '';

        // 🔥 关键修复：重置私钥变量，允许重新上传
        privateKey = null;
    }
}

function updateProgress(percent, text) {
    const formattedPercent = parseFloat(percent.toFixed(2));
    document.getElementById('progressFill').style.width = formattedPercent + '%';
    document.getElementById('progressText').textContent = formattedPercent + '%';
    document.getElementById('decryptStatusText').textContent = text;
}

function showError(message) {
    const statusMsg = document.getElementById('status-message');
    statusMsg.innerHTML = `<div class="message error">❌ ${message}</div>`;
    statusMsg.style.display = 'block';
}

// 🔥 新增：清除错误提示函数
function clearError() {
    const statusMsg = document.getElementById('status-message');
    statusMsg.innerHTML = '';
    statusMsg.style.display = 'none';
}

function updateTimelineCompleted() {
    const steps = document.querySelectorAll('.timeline-step');
    const lines = document.querySelectorAll('.timeline-line');

    steps.forEach(step => {
        step.classList.remove('active');
        step.classList.add('completed');
        const marker = step.querySelector('.step-marker');
        marker.innerHTML = '✓';
    });

    lines.forEach(line => {
        line.classList.add('completed');
    });
}

function updateTimelineToCompleted() {
    const steps = document.querySelectorAll('.timeline-step');
    const lines = document.querySelectorAll('.timeline-line');

    steps.forEach(step => {
        step.classList.remove('active');
        step.classList.add('completed');
        const marker = step.querySelector('.step-marker');
        marker.innerHTML = '✓';
    });

    lines.forEach(line => {
        line.classList.add('completed');
    });
}
</script>

<style>
.file-info-box {
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.file-info-box h3 {
    color: #667eea;
    margin-bottom: 15px;
}

.info-item {
    display: flex;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
}

.info-item:last-child {
    border-bottom: none;
}

.info-item .label {
    font-weight: 600;
    color: #666;
    min-width: 120px;
}

.key-upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 50px 20px;
    text-align: center;
    background: #f8f9ff;
    margin: 20px 0;
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.decrypt-status {
    text-align: center;
    padding: 40px 20px;
}

.status-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.decrypt-status h3 {
    color: #667eea;
    margin-bottom: 20px;
}

#progressText {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    color: #667eea;
}

.success-info {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    margin: 20px 0;
}

.success-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.success-info p {
    margin: 10px 0;
    font-size: 1.1rem;
}

.success-info strong {
    color: #667eea;
}

.security-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.feature-item h4 {
    color: #667eea;
    margin-bottom: 10px;
}

.feature-item p {
    font-size: 0.9rem;
    color: #666;
}

.info-box {
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.info-box h3 {
    color: #667eea;
    margin-bottom: 15px;
}

.info-box ol {
    margin-left: 20px;
    line-height: 1.8;
}

.info-box strong {
    color: #764ba2;
}

.button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 20px;
}

@media (max-width: 768px) {
    .button-group {
        grid-template-columns: 1fr;
    }
}

/* 状态时间线样式 */
.status-timeline-card {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
    border-left: 4px solid #667eea;
    margin-bottom: 20px;
}

.status-timeline-card h3 {
    color: #667eea;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

.timeline-horizontal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
}

.step-marker {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e0e0e0;
    color: #999;
    font-weight: bold;
    font-size: 1.2rem;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.timeline-step.completed .step-marker {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.timeline-step.active .step-marker {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    animation: markerPulse 2s ease-in-out infinite;
}

@keyframes markerPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
    50% { transform: scale(1.1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6); }
}

.pulse {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(0.8); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

.step-label {
    font-size: 0.85rem;
    color: #666;
    text-align: center;
    font-weight: 600;
    white-space: nowrap;
}

.timeline-step.completed .step-label {
    color: #28a745;
}

.timeline-step.active .step-label {
    color: #667eea;
}

.timeline-line {
    flex: 1;
    height: 3px;
    background: #e0e0e0;
    margin: 0 10px;
    position: relative;
    top: -20px;
}

.timeline-line.completed {
    background: linear-gradient(90deg, #28a745, #20c997);
}

/* 响应式优化 */
@media (max-width: 768px) {
    .timeline-horizontal {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
    }

    .timeline-step {
        flex: 0 0 80px;
    }

    .step-marker {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .step-label {
        font-size: 0.75rem;
    }

    .timeline-line {
        min-width: 30px;
        top: -15px;
    }

    .button-group {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
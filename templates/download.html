{% extends "base.html" %}

{% block title %}ä¸‹è½½æ–‡ä»¶ - E2EE æ–‡ä»¶ä¼ è¾“{% endblock %}

{% block content %}
<!-- çŠ¶æ€æ—¶é—´çº¿ -->
<div class="card status-timeline-card">
    <h3>ğŸ“Š ä¼ è¾“è¿›åº¦</h3>
    <div class="timeline-horizontal">
        <div class="timeline-step completed">
            <div class="step-marker">âœ“</div>
            <div class="step-label">é“¾æ¥å·²åˆ›å»º</div>
        </div>
        <div class="timeline-line completed"></div>

        <div class="timeline-step completed">
            <div class="step-marker">âœ“</div>
            <div class="step-label">æ–‡ä»¶å·²ä¸Šä¼ </div>
        </div>
        <div class="timeline-line completed"></div>

        <div class="timeline-step active">
            <div class="step-marker">
                <div class="pulse"></div>
            </div>
            <div class="step-label">ç­‰å¾…ä¸‹è½½</div>
        </div>
        <div class="timeline-line"></div>

        <div class="timeline-step">
            <div class="step-marker">â—‹</div>
            <div class="step-label">ä¼ è¾“å®Œæˆ</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ“¥ æ¥æ”¶åŠ å¯†æ–‡ä»¶</h2>
    <p>æœ‰äººå‘ä½ å‘é€äº†åŠ å¯†æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ä½ çš„ç§é’¥è¿›è¡Œè§£å¯†ã€‚</p>

    <div class="info-box">
        <h3>ğŸ”“ è§£å¯†æµç¨‹</h3>
        <ol>
            <li>ä¸Šä¼ ä½ ä¹‹å‰ä¸‹è½½çš„ <strong>private_key_xxxx.pem</strong> æ–‡ä»¶</li>
            <li>æµè§ˆå™¨å°†ä¸‹è½½åŠ å¯†æ–‡ä»¶å’Œå…¬é’¥åŠ å¯†çš„AESå¯†é’¥</li>
            <li>æµè§ˆå™¨ä½¿ç”¨ç§é’¥è§£å¯†AESå¯†é’¥</li>
            <li>æµè§ˆå™¨ä½¿ç”¨AESå¯†é’¥è§£å¯†æ–‡ä»¶</li>
            <li>ä¸‹è½½è§£å¯†åçš„åŸå§‹æ–‡ä»¶</li>
        </ol>
    </div>

    <div id="file-info" class="file-info-box">
        <h3>ğŸ“„ æ–‡ä»¶ä¿¡æ¯</h3>
        <div class="info-item">
            <span class="label">åŸå§‹æ–‡ä»¶åï¼š</span>
            <span id="originalFilename">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
            <span class="label">æ–‡ä»¶å¤§å°ï¼š</span>
            <span id="fileSize">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
            <span class="label">ä¸Šä¼ æ—¶é—´ï¼š</span>
            <span id="uploadTime">åŠ è½½ä¸­...</span>
        </div>
    </div>

    <div id="status-message"></div>

    <!-- æ­¥éª¤ 1: ä¸Šä¼ ç§é’¥ -->
    <div id="step-upload-key">
        <div class="key-upload-area">
            <input type="file" id="privateKeyInput" accept=".pem" style="display: none;" onchange="handlePrivateKeySelect(event)">
            <div class="upload-icon">ğŸ”‘</div>
            <p><strong>ç‚¹å‡»ä¸Šä¼ ç§é’¥æ–‡ä»¶</strong></p>
            <p class="text-muted">æ–‡ä»¶åé€šå¸¸ä¸º private_key_xxxxx.pem</p>
            <button class="btn" onclick="document.getElementById('privateKeyInput').click()">
                ğŸ“‚ é€‰æ‹©ç§é’¥æ–‡ä»¶
            </button>
        </div>

        <div class="message info">
            <strong>âš ï¸ å®‰å…¨æç¤ºï¼š</strong>
            <ul>
                <li>ç§é’¥æ–‡ä»¶<strong>ä¸ä¼šä¸Šä¼ </strong>åˆ°æœåŠ¡å™¨</li>
                <li>æ‰€æœ‰è§£å¯†æ“ä½œåœ¨<strong>ä½ çš„æµè§ˆå™¨</strong>ä¸­å®Œæˆ</li>
                <li>è§£å¯†åæœåŠ¡å™¨æ–‡ä»¶å°†<strong>ç«‹å³åˆ é™¤</strong></li>
            </ul>
        </div>
    </div>

    <!-- æ­¥éª¤ 2: è§£å¯†ä¸­ -->
    <div id="step-decrypting" style="display: none;">
        <div class="decrypt-status">
            <div class="status-icon">ğŸ”“</div>
            <h3 id="decryptStatusText">æ­£åœ¨ä¸‹è½½åŠ å¯†æ–‡ä»¶...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
    </div>
</div>

<!-- ä¸‹è½½æˆåŠŸæ¨¡æ€å¯¹è¯æ¡† -->
<div id="downloadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âœ… æ–‡ä»¶è§£å¯†æˆåŠŸï¼</h2>
        </div>

        <div class="modal-body">
            <div class="success-box">
                <div class="success-icon-large">ğŸ‰</div>
                <h3>æ–‡ä»¶å·²æˆåŠŸè§£å¯†</h3>
                <p class="success-message">
                    è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¿å­˜åˆ°æœ¬åœ°ï¼Œ
                    <span class="warning-text">åªæœ‰ä¸€æ¬¡ä¿å­˜æœºä¼š!!!</span>
                </p>
            </div>

            <div class="file-info-modal">
                <div class="info-row">
                    <span class="label">ğŸ“„ æ–‡ä»¶åï¼š</span>
                    <span class="value" id="modalFilename">-</span>
                </div>
                <div class="info-row">
                    <span class="label">ğŸ’¾ å¤§å°ï¼š</span>
                    <span class="value" id="modalFileSize">-</span>
                </div>
            </div>

            <div class="security-notice">
                <div class="notice-icon">ğŸ›¡ï¸</div>
                <div class="notice-content">
                    <strong>å®‰å…¨æç¤º</strong>
                    <ul>
                        <li>æ–‡ä»¶å·²åœ¨æœ¬åœ°è§£å¯†å®Œæˆ</li>
                        <li>æœåŠ¡å™¨ä¸Šçš„åŠ å¯†æ–‡ä»¶å·²è¢«åˆ é™¤</li>
                        <li>æ•´ä¸ªä¼ è¾“è¿‡ç¨‹ç«¯åˆ°ç«¯åŠ å¯†</li>
                    </ul>
                </div>
            </div>

            <div class="button-group-modal">
                <button class="btn btn-success btn-large" id="saveFileBtn" onclick="saveDecryptedFile()">
                    ğŸ’¾ ä¿å­˜æ–‡ä»¶
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ”’ éšç§ä¿æŠ¤</h2>
    <div class="security-features">
        <div class="feature-item">
            <div class="feature-icon">ğŸ–¥ï¸</div>
            <h4>æœ¬åœ°è§£å¯†</h4>
            <p>æ‰€æœ‰è§£å¯†åœ¨æµè§ˆå™¨å®Œæˆï¼Œç§é’¥ä¸ä¼šç¦»å¼€ä½ çš„è®¾å¤‡</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">ğŸ—‘ï¸</div>
            <h4>è‡ªåŠ¨é”€æ¯</h4>
            <p>è§£å¯†æˆåŠŸåï¼ŒæœåŠ¡å™¨æ–‡ä»¶ç«‹å³æ°¸ä¹…åˆ é™¤</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">ğŸš«</div>
            <h4>é›¶çŸ¥è¯†</h4>
            <p>æœåŠ¡å™¨ä»æœªæ¥è§¦è¿‡æ˜æ–‡æ•°æ®æˆ–ç§é’¥</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crypto.js"></script>
<script>
const urlToken = "{{ url_token }}";
let privateKey = null;
let fileInfo = null;
let decryptedFileBlob = null;
let decryptedFileName = '';

// é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶ä¿¡æ¯
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`/api/get-file-info/${urlToken}`);
        if (!response.ok) {
            throw new Error('æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯');
        }

        fileInfo = await response.json();

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        document.getElementById('originalFilename').textContent = fileInfo.original_filename;
        document.getElementById('fileSize').textContent = formatFileSize(fileInfo.file_size);
        document.getElementById('uploadTime').textContent = new Date(fileInfo.created_at).toLocaleString('zh-CN');

        console.log('âœ… æ–‡ä»¶ä¿¡æ¯åŠ è½½æˆåŠŸ');
    } catch (error) {
        console.error('âŒ æ–‡ä»¶ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
        showError('æ— æ³•åŠ è½½æ–‡ä»¶ä¿¡æ¯: ' + error.message);
    }
});

async function handlePrivateKeySelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
        clearError();

        // è¯»å–ç§é’¥æ–‡ä»¶
        const privateKeyPem = await readFileAsText(file);

        // éªŒè¯ç§é’¥æ ¼å¼
        if (!privateKeyPem.includes('-----BEGIN PRIVATE KEY-----')) {
            throw new Error('æ— æ•ˆçš„ç§é’¥æ–‡ä»¶æ ¼å¼');
        }

        // å¯¼å…¥ç§é’¥
        privateKey = await importPrivateKey(privateKeyPem);
        console.log('âœ… ç§é’¥å¯¼å…¥æˆåŠŸ');

        // å¼€å§‹è§£å¯†æµç¨‹
        await startDecryption();

    } catch (error) {
        console.error('âŒ ç§é’¥å¤„ç†å¤±è´¥:', error);
        showError('ç§é’¥æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºæ­£ç¡®çš„ç§é’¥æ–‡ä»¶');
        document.getElementById('privateKeyInput').value = '';
    }
}

async function startDecryption() {
    if (!privateKey || !fileInfo) {
        showError('è¯·å…ˆä¸Šä¼ ç§é’¥å¹¶ç­‰å¾…æ–‡ä»¶ä¿¡æ¯åŠ è½½');
        return;
    }

    clearError();

    document.getElementById('step-upload-key').style.display = 'none';
    document.getElementById('step-decrypting').style.display = 'block';

    try {
        const isLargeFile = fileInfo.file_size > 50 * 1024 * 1024;

        updateProgress(10, 'æ­£åœ¨ä¸‹è½½åŠ å¯†æ–‡ä»¶...');
        const fileResponse = await fetch(`/api/download/${urlToken}`);
        if (!fileResponse.ok) {
            throw new Error('ä¸‹è½½åŠ å¯†æ–‡ä»¶å¤±è´¥');
        }

        const reader = fileResponse.body.getReader();
        const chunks = [];
        let receivedLength = 0;

        while(true) {
            const {done, value} = await reader.read();
            if (done) break;

            chunks.push(value);
            receivedLength += value.length;

            const downloadPercent = Math.round(receivedLength / fileInfo.file_size * 100);
            updateProgress(10 + downloadPercent * 0.2, `ä¸‹è½½ä¸­... ${downloadPercent}%`);
        }

        const encryptedData = new Uint8Array(receivedLength);
        let position = 0;
        for(const chunk of chunks) {
            encryptedData.set(chunk, position);
            position += chunk.length;
        }

        updateProgress(35, 'æ­£åœ¨æå–åŠ å¯†å‚æ•°...');
        const iv = encryptedData.slice(0, 12);
        const encryptedFile = encryptedData.slice(12);

        updateProgress(40, 'æ­£åœ¨è·å–åŠ å¯†å¯†é’¥...');
        const keyResponse = await fetch(`/api/get-encrypted-key/${urlToken}`);
        if (!keyResponse.ok) {
            throw new Error('è·å–åŠ å¯†å¯†é’¥å¤±è´¥');
        }
        const keyData = await keyResponse.json();
        const encryptedAESKey = base64ToArrayBuffer(keyData.encrypted_aes_key);

        updateProgress(50, 'æ­£åœ¨è§£å¯†ä¼ è¾“å¯†é’¥...');
        const aesKey = await decryptAESKeyWithRSA(encryptedAESKey, privateKey);
        console.log('âœ… AES å¯†é’¥è§£å¯†æˆåŠŸ');

        let decryptedFile;

        if (isLargeFile) {
            updateProgress(55, 'æ­£åœ¨è§£å¯†å¤§æ–‡ä»¶ï¼ˆåˆ†å—å¤„ç†ï¼‰...');

            const CHUNK_SIZE = 5 * 1024 * 1024 + 16;
            const encryptedChunks = [];

            for (let i = 0; i < encryptedFile.length; i += CHUNK_SIZE) {
                encryptedChunks.push(encryptedFile.slice(i, Math.min(i + CHUNK_SIZE, encryptedFile.length)));
            }

            decryptedFile = await decryptFileInChunks(
                encryptedChunks,
                aesKey,
                iv,
                (percent) => {
                    updateProgress(55 + percent * 0.3, `è§£å¯†ä¸­... ${percent}%`);
                }
            );
        } else {
            updateProgress(60, 'æ­£åœ¨è§£å¯†æ–‡ä»¶å†…å®¹...');
            decryptedFile = await decryptFileWithAES(encryptedFile.buffer, aesKey, iv);
        }

        console.log('âœ… æ–‡ä»¶è§£å¯†æˆåŠŸ');

        // å­˜å‚¨è§£å¯†åçš„æ–‡ä»¶
        updateProgress(90, 'æ­£åœ¨å‡†å¤‡æ–‡ä»¶...');
        decryptedFileBlob = new Blob([decryptedFile]);
        decryptedFileName = fileInfo.original_filename;

        // é€šçŸ¥æœåŠ¡å™¨åˆ é™¤æ–‡ä»¶
        updateProgress(95, 'æ­£åœ¨æ¸…ç†æœåŠ¡å™¨æ–‡ä»¶...');
        await fetch(`/api/confirm-download/${urlToken}`, { method: 'POST' });

        updateProgress(100, 'å®Œæˆï¼');

        // æ›´æ–°æ—¶é—´çº¿ä¸ºå…¨éƒ¨å®Œæˆ
        updateTimelineCompleted();

        // éšè—è§£å¯†ç•Œé¢ï¼Œæ˜¾ç¤ºæ¨¡æ€å¯¹è¯æ¡†
        setTimeout(() => {
            document.getElementById('step-decrypting').style.display = 'none';
            openDownloadModal();
        }, 500);

    } catch (error) {
        console.error('âŒ è§£å¯†å¤±è´¥:', error);
        showError('è§£å¯†å¤±è´¥: ' + error.message + '<br>è¯·ç¡®è®¤ç§é’¥æ˜¯å¦æ­£ç¡®');
        document.getElementById('step-decrypting').style.display = 'none';
        document.getElementById('step-upload-key').style.display = 'block';
        document.getElementById('privateKeyInput').value = '';
        privateKey = null;
    }
}

// ğŸ”¥ æ–°å¢ï¼šæ‰“å¼€ä¸‹è½½æ¨¡æ€å¯¹è¯æ¡†
function openDownloadModal() {
    const modal = document.getElementById('downloadModal');

    // è®¾ç½®æ–‡ä»¶ä¿¡æ¯
    document.getElementById('modalFilename').textContent = decryptedFileName;
    document.getElementById('modalFileSize').textContent = formatFileSize(decryptedFileBlob.size);

    // é‡ç½®æŒ‰é’®çŠ¶æ€
    const saveBtn = document.getElementById('saveFileBtn');
    saveBtn.classList.remove('downloaded');
    saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜æ–‡ä»¶';
    saveBtn.disabled = false;

    // æ˜¾ç¤ºå¯¹è¯æ¡†
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

// ğŸ”¥ æ–°å¢ï¼šä¿å­˜è§£å¯†åçš„æ–‡ä»¶
function saveDecryptedFile() {
    if (!decryptedFileBlob || !decryptedFileName) {
        alert('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }

    // ä¸‹è½½æ–‡ä»¶
    downloadFile(decryptedFileBlob, decryptedFileName);

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const saveBtn = document.getElementById('saveFileBtn');
    saveBtn.classList.add('downloaded');
    saveBtn.innerHTML = 'âœ… å·²ä¿å­˜';
    saveBtn.disabled = true;

    console.log('âœ… æ–‡ä»¶å·²ä¿å­˜:', decryptedFileName);
}

// è¾…åŠ©å‡½æ•°
function downloadFile(blob, filename) {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function updateProgress(percent, text) {
    const formattedPercent = parseFloat(percent.toFixed(2));
    document.getElementById('progressFill').style.width = formattedPercent + '%';
    document.getElementById('progressText').textContent = formattedPercent + '%';
    document.getElementById('decryptStatusText').textContent = text;
}

function showError(message) {
    const statusMsg = document.getElementById('status-message');
    statusMsg.innerHTML = `<div class="message error">âŒ ${message}</div>`;
    statusMsg.style.display = 'block';
}

function clearError() {
    const statusMsg = document.getElementById('status-message');
    statusMsg.innerHTML = '';
    statusMsg.style.display = 'none';
}

function updateTimelineCompleted() {
    const steps = document.querySelectorAll('.timeline-step');
    const lines = document.querySelectorAll('.timeline-line');

    steps.forEach(step => {
        step.classList.remove('active');
        step.classList.add('completed');
        const marker = step.querySelector('.step-marker');
        marker.innerHTML = 'âœ“';
    });

    lines.forEach(line => {
        line.classList.add('completed');
    });
}
</script>

<style>
.warning-text {
    color: #dc3545;
    font-weight: bold;
    font-size: 1.1em;
    text-shadow: 0 1px 2px rgba(220, 53, 69, 0.3);
}

.file-info-box {
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.file-info-box h3 {
    color: #667eea;
    margin-bottom: 15px;
}

.info-item {
    display: flex;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
}

.info-item:last-child {
    border-bottom: none;
}

.info-item .label {
    font-weight: 600;
    color: #666;
    min-width: 120px;
}

.key-upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 50px 20px;
    text-align: center;
    background: #f8f9ff;
    margin: 20px 0;
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.decrypt-status {
    text-align: center;
    padding: 40px 20px;
}

.status-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.decrypt-status h3 {
    color: #667eea;
    margin-bottom: 20px;
}

#progressText {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    color: #667eea;
}

.security-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.feature-item h4 {
    color: #667eea;
    margin-bottom: 10px;
}

.feature-item p {
    font-size: 0.9rem;
    color: #666;
}

.info-box {
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.info-box h3 {
    color: #667eea;
    margin-bottom: 15px;
}

.info-box ol {
    margin-left: 20px;
    line-height: 1.8;
}

.info-box strong {
    color: #764ba2;
}

/* çŠ¶æ€æ—¶é—´çº¿æ ·å¼ */
.status-timeline-card {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
    border-left: 4px solid #667eea;
    margin-bottom: 20px;
}

.status-timeline-card h3 {
    color: #667eea;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

.timeline-horizontal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
}

.step-marker {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e0e0e0;
    color: #999;
    font-weight: bold;
    font-size: 1.2rem;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.timeline-step.completed .step-marker {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.timeline-step.active .step-marker {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    animation: markerPulse 2s ease-in-out infinite;
}

@keyframes markerPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
    50% { transform: scale(1.1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6); }
}

.pulse {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(0.8); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

.step-label {
    font-size: 0.85rem;
    color: #666;
    text-align: center;
    font-weight: 600;
    white-space: nowrap;
}

.timeline-step.completed .step-label {
    color: #28a745;
}

.timeline-step.active .step-label {
    color: #667eea;
}

.timeline-line {
    flex: 1;
    height: 3px;
    background: #e0e0e0;
    margin: 0 10px;
    position: relative;
    top: -20px;
}

.timeline-line.completed {
    background: linear-gradient(90deg, #28a745, #20c997);
}

/* æ¨¡æ€å¯¹è¯æ¡†åŸºç¡€æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
    animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideUp {
    from {
        transform: translateY(60px) scale(0.95);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.modal-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 30px;
    border-radius: 20px 20px 0 0;
    text-align: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.8rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.modal-body {
    padding: 35px;
}

/* æˆåŠŸæç¤ºæ¡† */
.success-box {
    text-align: center;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-radius: 16px;
    border-left: 5px solid #28a745;
}

.success-icon-large {
    font-size: 4rem;
    margin-bottom: 15px;
    animation: bounceIn 0.8s ease-out;
}

@keyframes bounceIn {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.success-box h3 {
    color: #155724;
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.success-message {
    color: #155724;
    font-size: 1.1rem;
    margin: 0;
    line-height: 1.6;
}

/* æ–‡ä»¶ä¿¡æ¯ */
.file-info-modal {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e0e0e0;
}

.info-row:last-child {
    border-bottom: none;
}

.info-row .label {
    font-weight: 600;
    color: #666;
    font-size: 1rem;
}

.info-row .value {
    color: #333;
    font-weight: 500;
    font-size: 1rem;
    word-break: break-all;
    text-align: right;
    max-width: 60%;
}

/* å®‰å…¨æç¤º */
.security-notice {
    display: flex;
    gap: 15px;
    background: linear-gradient(135deg, #e8f4f8, #d1ecf1);
    border-left: 4px solid #17a2b8;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.notice-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
}

.notice-content {
    flex: 1;
}

.notice-content strong {
    color: #0c5460;
    font-size: 1.1rem;
    display: block;
    margin-bottom: 10px;
}

.notice-content ul {
    margin: 0;
    padding-left: 20px;
    color: #0c5460;
    line-height: 1.8;
}

.notice-content li {
    margin-bottom: 5px;
}

/* æŒ‰é’®ç»„ */
.button-group-modal {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.btn-large {
    padding: 16px 24px;
    font-size: 1.1rem;
    font-weight: 700;
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    position: relative;
    overflow: hidden;
}

.btn-success::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn-success:hover::before {
    width: 300px;
    height: 300px;
}

.btn-success:hover {
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
    transform: translateY(-2px);
}

.btn-success:active {
    transform: translateY(0);
}

.btn-success.downloaded {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    cursor: default;
    pointer-events: none;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .timeline-horizontal {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
    }

    .timeline-step {
        flex: 0 0 80px;
    }

    .step-marker {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .step-label {
        font-size: 0.75rem;
    }

    .timeline-line {
        min-width: 30px;
        top: -15px;
    }

    .modal-content {
        width: 95%;
        max-height: 95vh;
    }

    .modal-body {
        padding: 25px;
    }

    .button-group-modal {
        grid-template-columns: 1fr;
    }

    .info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .info-row .value {
        text-align: left;
        max-width: 100%;
    }

    .security-notice {
        flex-direction: column;
        text-align: center;
    }
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
.modal-content::-webkit-scrollbar {
    width: 8px;
}

.modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 0 20px 20px 0;
}

.modal-content::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}
</style>
{% endblock %}